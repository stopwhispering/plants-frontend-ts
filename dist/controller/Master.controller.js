sap.ui.define(["plants/ui/controller/BaseController","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/FilterType","sap/ui/model/Sorter","plants/ui/model/formatter","sap/m/MessageToast","plants/ui/customClasses/Util","plants/ui/customClasses/Navigation","sap/ui/core/Fragment"],function(e,t,n,a,o,s,i,r,l,d,c){function p(e){return e&&e.__esModule&&typeof e.default!=="undefined"?e.default:e}const g=p(e);const u=p(i);const h=p(d);const m=g.extend("plants.ui.controller.Master",{constructor:function e(){g.prototype.constructor.apply(this,arguments);this.formatter=new u;this.navigation=h.getInstance();this.mIdToFragment={popoverPopupImage:"plants.ui.view.fragments.master.MasterImagePopover",settingsDialogFilter:"plants.ui.view.fragments.master.MasterFilter",dialogNewPlant:"plants.ui.view.fragments.master.MasterNewPlant",dialogSort:"plants.ui.view.fragments.master.MasterSort"}},onInit:function e(){g.prototype.onInit.call(this)},onAfterRendering:function e(){var t=this.byId("plantsTable");t.attachUpdateFinished(this.updateTableHeaderPlantsCount.bind(this))},applyToFragment:function e(t,n,a){g.prototype.applyToFragment.call(this,t,n,a,this.mIdToFragment)},onListItemPress:function e(t){var n=t.getSource().getBindingContext("plants").getObject();this.navigation.navToPlantDetails(n.id)},onSearch:function e(t){var s=t.getParameter("query");const i=this.getView().byId("plantsTable").getBinding("items");const r=i.getFilters(o.Application);var l=[];const d=["plant_name","botanical_name",undefined];for(var c=0;c<r.length;c++){const e=r[c];const t=e.getPath();if(!(d.indexOf(t)>-1)){l.push(r[c])}}var p=[new n("plant_name",a.Contains,s),new n("botanical_name",a.Contains,s)];var g=new n({filters:p,and:false});l.push(g);i.filter(l,o.Application);this.updateTableHeaderPlantsCount()},_getDistinctTagsFromPlants:function e(t){var n=[];for(var a=0;a<t.length;a++){var o=t[a].tags;if(!!o.length){var s=o.map(function(e){return e.text});n=n.concat(s)}}return Array.from(new Set(n))},onShowFilterDialog:function e(n){var a=this.oComponent.getModel("filterValues");var o=this.byId("plantsTable").getBinding("items");var s=o.getDistinctValues("current_soil/soil_name");a.setProperty("/soilNames",s);var i=o.getDistinctValues("propagation_type");a.setProperty("/propagationTypes",i);var r=o.getDistinctValues("nursery_source");a.setProperty("/nurseriesSources",r);var d=this.oComponent.getModel("plants").getData().PlantsCollection;var p=this._getDistinctTagsFromPlants(d);a.setProperty("/tags",p);var g=l.getServiceUrl("selection_data");if(!this.oModelTaxonTree){this.oModelTaxonTree=new t(g)}var u=this.getView();const h=this.byId("settingsDialogFilter");if(!h){c.load({name:"plants.ui.view.fragments.master.MasterFilter",id:u.getId(),controller:this}).then(e=>{const t=e;u.addDependent(t);t.setModel(this.oModelTaxonTree,"selection");t.open()})}else{h.setModel(this.oModelTaxonTree,"selection");h.open()}},_addSelectedFlag:function e(t,n){const a=this;t.forEach(function(e){let t=e;t.selected=n;if(!!t.nodes&&t.nodes.length>0){a._addSelectedFlag(t.nodes,n)}})},onSelectionChangeTaxonTree:function e(t){var n=t.getParameter("listItems");let a=this;n.forEach(function(e){var t=e.getBindingContext("selection").getObject();var n=e.getSelected();if(t.nodes){a._addSelectedFlag(t.nodes,n)}});this.oModelTaxonTree.refresh()},_getSelectedItems:function e(t,n){let a=[];let o=[];const s=this;t.forEach(function(e){if(e.level===n&&e.selected){a.push(e);if(e.plant_ids)o=o.concat(e.plant_ids)}else if(e.nodes&&e.nodes.length>0){var t=s._getSelectedItems(e.nodes,n);if(t[0].length>0){a=a.concat(t[0])}if(t[1].length>0){o=o.concat(t[1])}}},this);return[a,o]},onConfirmFilters:function e(t){const o=this.byId("plantsTable");const s=t.getParameter("filterItems");const i=t.getParameter("filterString");const r=o.getBinding("items");const l=[];const d=["plant_name","botanical_name"];const c=r.getFilters("Application");for(var p=0;p<c.length;p++){const e=c[p];const t=e.getPath();if(d.indexOf(t)>-1){l.push(c[p])}}let g=[];s.forEach(function(e){var t=e.getKey().split("___"),a=t[0],o=t[1],s=t[2],i=t[3];switch(a){case"tags/text":g.push(s);break;default:var r=new n(a,o,s,i);l.push(r);if(s==""){r=new n(a,o,undefined,i);l.push(r)}break}});if(g.length>0){var u=new n({path:"tags",value1:g,comparator(e,t){var n=e.some(function(e){return t.includes(e.text)});return n?0:-1},operator:a.EQ});l.push(u)}var h=2;const m=this.byId("taxonTree").getSelectedItems();if(m.length>0){var f=this.oModelTaxonTree.getProperty("/Selection/TaxonTree");var v=this._getSelectedItems(f,h);var y=v[1];var I=y.map(e=>new n("id",a.EQ,e));var T=new n({filters:I,and:false});l.push(T)}this.byId("tableFilterBar").setVisible(l.length>0);this.byId("tableFilterLabel").setText(i);var w=this._getHiddenPlantsFilter();if(w){l.push(w)}r.filter(l);this.updateTableHeaderPlantsCount();var P=this.byId("sbtnPreviewImage").getSelectedKey()||"favourite_image";this.oComponent.getModel("status").setProperty("/preview_image",P)},_getHiddenPlantsFilter:function e(){var t=this.byId("sbtnHiddenPlants").getSelectedKey();switch(t){case"both":return undefined;case"only_hidden":return new n("active",a.EQ,false);default:return new n("active",a.EQ,true)}},onAdd:function e(t){var n=this.getView();const a=this.byId("dialogNewPlant");if(!a){c.load({name:this.mIdToFragment["dialogNewPlant"],id:n.getId(),controller:this}).then(e=>{e.open()})}else{a.open()}},onAddSaveButton:function e(t){var n=this.byId("inputCreateNewPlantName").getValue();if(n===""){r.show("Empty not allowed.");return}if(n.includes("/")){r.show("Forward slash not allowed.");return}if(this.isPlantNameInPlantsModel(n)){r.show("Plant Name already exists.");return}this.saveNewPlant({plant_name:n,active:true,descendant_plants_all:[],sibling_plants:[],same_taxon_plants:[],tags:[]});this.applyToFragment("dialogNewPlant",e=>e.close())},onShowSortDialog:function e(t){this.applyToFragment("dialogSort",e=>e.open())},handleSortDialogConfirm:function e(t){const n=this.byId("plantsTable");const a=t.getParameter("sortItem");const o=t.getParameter("sortDescending");const i=n.getBinding("items");let r;const l=[];r=a.getKey();l.push(new s(r,o));i.sort(l)},onResetFilters:function e(t){var n=l.getServiceUrl("selection_data");this.oModelTaxonTree.loadData(n)},onHoverImage:function e(t,n){var a=t.getBindingContext("plants");var o=this.getView();const s=this.byId("popoverPopupImage");if(!s){c.load({name:this.mIdToFragment["popoverPopupImage"],id:o.getId(),controller:this}).then(e=>{const n=e;o.addDependent(n);n.setBindingContext(a,"plants");n.openBy(t,true)})}else{s.setBindingContext(a,"plants");s.openBy(t,true)}},onClickImagePopupImage:function e(t){this.applyToFragment("popoverPopupImage",e=>{if(e.isOpen()){e.close()}})},onHoverAwayFromImage:function e(t,n){this.applyToFragment("popoverPopupImage",e=>{if(e.isOpen()){e.close()}})}});return m});