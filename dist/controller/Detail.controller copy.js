sap.ui.define(["plants/ui/customClasses/BaseController","sap/ui/model/json/JSONModel","sap/ui/model/Filter","plants/ui/model/formatter","sap/m/MessageBox","sap/m/MessageToast","plants/ui/customClasses/Util","plants/ui/customClasses/Navigation","plants/ui/customClasses/MessageUtil","plants/ui/model/ModelsHelper","plants/ui/customClasses/EventsUtil","sap/ui/model/Sorter","sap/ui/model/FilterOperator","plants/ui/customClasses/ImageToTaxon","plants/ui/customClasses/PropertiesUtil","plants/ui/customClasses/ImageUtil","plants/ui/customClasses/TraitUtil","plants/ui/customClasses/TaxonomyUtil"],function(e,t,n,a,i,s,l,o,r,d,g,u,p,h,c,P,m,f){"use strict";return e.extend("plants.ui.controller.Detail",{formatter:a,EventsUtil:g,PropertiesUtil:c,ImageToTaxon:h,modelsHelper:d.getInstance(),ImageUtil:P.getInstance(),TraitUtil:m.getInstance(),TaxonomyUtil:f.getInstance(),onInit:function(){this._oRouter=this.getOwnerComponent().getRouter();this.oLayoutModel=this.getOwnerComponent().getModel();this.getOwnerComponent().getModel("status").setProperty("/details_editable",false);this._oRouter.getRoute("detail").attachPatternMatched(this._onPatternMatched,this);this._oRouter.getRoute("untagged").attachPatternMatched(this._onPatternMatched,this);var e=this.byId("eventsList");e.bindAggregation("items",{path:"events>",templateShareable:false,factory:this.EventsUtil.eventsListFactory.bind(this),sorter:new u("date",true)});this._oCurrentPlant=null;this._currentPlantId=null;this._currentPlantIndex=null;this.getOwnerComponent().getModel("status").setProperty("/images_editable",false)},_onPatternMatched:function(e){l.startBusyDialog();this._currentPlantId=parseInt(e.getParameter("arguments").plant_id||this.plant_id||"0");this._bindModelsForCurrentPlant()},_bindModelsForCurrentPlant:function(){var e=this.getOwnerComponent().getModel("plants");var t=e.dataLoaded();t.then(this._bindPlantsModelDeferred.bind(this),this._bindPlantsModelDeferred.bind(this));this._loadBindEventsModel();if(!this.getOwnerComponent().imagesPlantsLoaded.has(this._currentPlantId)){this.requestImagesForPlant(this._currentPlantId)}else{this.resetImagesCurrentPlant(this._currentPlantId)}},_loadBindEventsModel:function(){this.getView().bindElement({path:"/PlantsEventsDict/"+this._currentPlantId,model:"events"});var e=this.getOwnerComponent().getModel("events");if(!e.getProperty("/PlantsEventsDict/"+this._currentPlantId+"/")){this._loadEventsForCurrentPlant()}},_bindPlantsModelDeferred:function(){var e=this.getOwnerComponent().getModel("plants").getProperty("/PlantsCollection");this._currentPlantIndex=e.findIndex(e=>e.id===this._currentPlantId);if(this._currentPlantIndex===-1){s.show("Plant ID "+this._currentPlantId+" not found. Redirecting.");this._currentPlantIndex=0}var t="/PlantsCollection/"+this._currentPlantIndex;this._oCurrentPlant=this.getOwnerComponent().getModel("plants").getProperty(t);if(!this._oCurrentPlant.parent_plant){this._oCurrentPlant.parent_plant={id:undefined,plant_name:undefined,active:undefined}}if(!this._oCurrentPlant.parent_plant_pollen){this._oCurrentPlant.parent_plant_pollen={id:undefined,plant_name:undefined,active:undefined}}this.getView().bindElement({path:t,model:"plants"});this._bindTaxonOfCurrentPlantDeferred(this._oCurrentPlant);this._loadBindProperties()},_loadBindProperties:function(){this.getView().bindElement({path:"/propertiesPlants/"+this._oCurrentPlant.id,model:"properties"});var e=this.getOwnerComponent().getModel("properties");if(!e.getProperty("/propertiesPlants/"+this._oCurrentPlant.id+"/")){c.loadPropertiesForCurrentPlant(this._oCurrentPlant,this.getOwnerComponent())}},_loadEventsForCurrentPlant:function(){var e="events/"+this._currentPlantId;$.ajax({url:l.getServiceUrl(e),data:{},context:this,async:true}).done(this._onReceivingEventsForPlant.bind(this,this._currentPlantId)).fail(this.ModelsHelper.getInstance().onReceiveErrorGeneric.bind(this,"Event (GET)"))},_onReceivingEventsForPlant:function(e,t,n,a){var i=this.getOwnerComponent().getModel("events");i.setProperty("/PlantsEventsDict/"+e+"/",t.events);if(!this.getOwnerComponent().oEventsDataClone){this.getOwnerComponent().oEventsDataClone={}}this.getOwnerComponent().oEventsDataClone[e]=l.getClonedObject(t.events);r.getInstance().addMessageFromBackend(t.message)},_bindTaxonOfCurrentPlantDeferred:function(e){this.getView().bindElement({path:"/TaxaDict/"+e.taxon_id,model:"taxon"})},handleFullScreen:function(){var e=this.oLayoutModel.getProperty("/actionButtonsInfo/midColumn/fullScreen");this._oRouter.navTo("detail",{layout:e,plant_id:this._oCurrentPlant.id})},handleExitFullScreen:function(){var e=this.oLayoutModel.getProperty("/actionButtonsInfo/midColumn/exitFullScreen");this._oRouter.navTo("detail",{layout:e,plant_id:this._oCurrentPlant.id})},handleClose:function(){var e=this.oLayoutModel.getProperty("/actionButtonsInfo/midColumn/closeColumn");this._oRouter.navTo("master",{layout:e})},onChangeActiveSwitch:function(e){if(!e.getParameter("state")){var t=e.getSource();this.applyToFragment("dialogCancellation",e=>e.openBy(t),n.bind(this));function n(e){this.getView().byId("cancellationDate").setDateValue(new Date)}}},onIconPressSetPreview:function(e){var t=e.getSource().getBindingContext("images").getPath();var n=this.getOwnerComponent().getModel("images").getProperty(t);var a=e.getSource().getBindingContext("plants").getPath();var i=this.getOwnerComponent().getModel("plants").getProperty(a);var s=n["filename"];var l=JSON.stringify(s);var o=l.substring(1,l.length-1);i["url_preview"]=o;i["filename_previewimage"]=n["filename"];this.getOwnerComponent().getModel("plants").updateBindings()},onSetInactive:function(e){var t=this.getOwnerComponent().getModel("suggestions").getProperty("/cancellationReasonCollection");var n=t.find(e=>e.selected);this.getView().getBindingContext("plants").getObject().cancellation_reason=n.text;var a=l.formatDate(this.byId("cancellationDate").getDateValue());this.getView().getBindingContext("plants").getObject().cancellation_date=a;this.getOwnerComponent().getModel("plants").updateBindings();this.byId("dialogCancellation").close()},onChangeParent:function(e){console.log(e.mParameters.newValue);var t=this.getView().getModel("plants").getProperty("/PlantsCollection");var n=t.find(t=>t.plant_name===e.getParameter("newValue").trim());if(!e.getParameter("newValue").trim()||!n){var a={id:undefined,plant_name:undefined,active:undefined}}else{a={id:n.id,plant_name:n.plant_name,active:n.active}}if(e.getSource().data("parentType")==="parent_pollen"){this._oCurrentPlant.parent_plant_pollen=a}else{this._oCurrentPlant.parent_plant=a}},onPressGoToPlant:function(e){if(!!e){o.navToPlantDetails.call(this,e)}else{this.handleErrorMessageBox("Can't determine Plant Index")}},onSuggestNursery:function(e){var t=[];var a=e.getParameter("suggestValue");if(a){t.push(new n("name",p.Contains,a))}e.getSource().getBinding("suggestionItems").filter(t);e.getSource().setFilterSuggests(false)},onPressButtonDeletePlant:function(e,t,n){if(t.length<1){return}var a=e.getSource().getBindingContext("plants");var s=!!this.getView().$().closest(".sapUiSizeCompact").length;i.confirm("Delete plant "+t+"?",{icon:i.Icon.WARNING,title:"Delete",stretch:false,onClose:this._confirmDeletePlant.bind(this,t,n,a),actions:["Delete","Cancel"],styleClass:s?"sapUiSizeCompact":""})},onPressButtonClonePlant:function(e){var t=this.getModifiedPlants();var n=this.getModifiedImages();var a=this.getModifiedTaxa();if(t.length!==0||n.length!==0||a.length!==0){s.show("There are unsaved changes. Save modified data or reload data first.");return}this.applyToFragment("dialogClonePlant",e=>{var t=this._generatePlantNameWithRomanizedSuffix(this._oCurrentPlant.plant_name,2);this.byId("inputClonedPlantName").setValue(t);e.open()})},_confirmDeletePlant:function(e,t,n,a){if(a!=="Delete"){return}l.startBusyDialog("Deleting","Deleting "+e);$.ajax({url:l.getServiceUrl("plants/"),type:"DELETE",contentType:"application/json",data:JSON.stringify({plant_id:t}),context:this}).done(this._onPlantDeleted.bind(this,n)).fail(d.getInstance().onReceiveErrorGeneric.bind(this,"Plant (DELETE)"))},_onPlantDeleted:function(e,t,n,a){l.stopBusyDialog();this.onAjaxSimpleSuccess(t,n,a);var i=this.getView().getModel("plants").getData().PlantsCollection;var s=e.getProperty();var o=i.indexOf(s);i.splice(o,1);this.getView().getModel("plants").refresh();var r=this.getOwnerComponent().oPlantsDataClone.PlantsCollection;var d=r.find(function(e){return e.plant_name===s.plant_name});if(d!==undefined){r.splice(r.indexOf(d),1)}this.handleClose()},onToggleEditMode:function(e){var t=e.getSource().getType();if(t==="Transparent"){e.getSource().setType("Emphasized");this.getView().getModel("status").setProperty("/details_editable",true)}else{e.getSource().setType("Transparent");this.getView().getModel("status").setProperty("/details_editable",false)}},onPressTag:function(e){var t=e.getSource();var n=t.getBindingContext("plants").getPath();this.applyToFragment("menuDeleteTag",e=>{e.bindElement({path:n,model:"plants"});e.openBy(t)})},pressDeleteTag:function(e){var t=e.getSource().getBindingContext("plants");var n=t.getPath();var a=n.substr(n.lastIndexOf("/")+1);this.getOwnerComponent().getModel("plants").getData().PlantsCollection[this._currentPlantIndex].tags.splice(a,1);this.getOwnerComponent().getModel("plants").refresh()},onOpenAddTagDialog:function(e){var n=e.getSource();this.applyToFragment("dialogAddTag",e=>e.openBy(n),a.bind(this));function a(e){var n={ObjectStatusCollection:[{selected:false,text:"None",state:"None"},{selected:false,text:"Indication01",state:"Indication01"},{selected:false,text:"Success",state:"Success"},{selected:true,text:"Information",state:"Information"},{selected:false,text:"Error",state:"Error"},{selected:false,text:"Warning",state:"Warning"}],Value:""};var a=new t(n);e.setModel(a,"tagTypes")}},onAddTag:function(e){var t=this.byId("dialogAddTag").getModel("tagTypes").getData();t.Value=t.Value.trim();if(t.Value.length===0){s.show("Enter text first.");return}var n=t.ObjectStatusCollection.find(function(e){return e.selected});var a=this.getOwnerComponent().getModel("plants").getData().PlantsCollection[this._currentPlantIndex];if(a.tags){var i=a.tags.find(function(e){return e.text===t.Value});if(i){s.show("Tag already exists.");return}}var l={text:t.Value,state:n.state,plant_id:a.id};if(a.tags){a.tags.push(l)}else{a.tags=[l]}this.getOwnerComponent().getModel("plants").updateBindings();this.byId("dialogAddTag").close()},onPressButtonRenamePlant:function(e){var t=this.getModifiedPlants();var n=this.getModifiedImages();var a=this.getModifiedTaxa();if(t.length!==0||n.length!==0||a.length!==0){s.show("There are unsaved changes. Save modified data or reload data first.");return}this.applyToFragment("dialogRenamePlant",e=>{this.byId("inputNewPlantName").setValue(this._oCurrentPlant.plant_name);e.open()})},onLiveChangeNewPlantName:function(e,t){var n=e.getParameter("value");if(t==="clone"){this.byId("btnClonePlantSubmit").setEnabled(n.length>0)}else if(t==="rename"){this.byId("btnRenamePlantSubmit").setEnabled(n.length>0)}else if(t==="descendant"){this.byId("btnDescendantDialogCreate").setEnabled(n.length>0)}},onPressButtonSubmitClonePlant:function(e){var t=this.byId("inputClonedPlantName").getValue().trim();if(t===""){s.show("Empty not allowed.");return}if(this.isPlantNameInPlantsModel(t)){s.show("Plant Name already exists.");return}l.startBusyDialog("Cloning...",'"'+this._oCurrentPlant.plant_name+'" to "'+t+'"');$.ajax({url:l.getServiceUrl("plants/"+this._oCurrentPlant.id+"/clone?plant_name_clone="+t),type:"POST",contentType:"application/json",context:this}).done(this._onReceivingPlantCloned).fail(d.getInstance().onReceiveErrorGeneric.bind(this,"Clone Plant (POST)"))},_onReceivingPlantCloned:function(e,t,n){this.applyToFragment("dialogClonePlant",e=>e.close());r.getInstance().addMessageFromBackend(e.message);var a=e.plants[0];var i=this.getOwnerComponent().getModel("plants").getProperty("/PlantsCollection");i.push(a);this.getOwnerComponent().getModel("plants").updateBindings();var d=l.getClonedObject(a);this.getOwnerComponent().oPlantsDataClone.PlantsCollection.push(d);s.show(e.message.message);o.navToPlantDetails.call(this,a.id);l.stopBusyDialog()},onPressButtonSubmitRenamePlant:function(e){var t=this.byId("inputNewPlantName").getValue().trim();if(t===""){s.show("Empty not allowed.");return}if(this.isPlantNameInPlantsModel(t)){s.show("Plant Name already exists.");return}l.startBusyDialog("Renaming...",'"'+this._oCurrentPlant.plant_name+'" to "'+t+'"');var n={OldPlantName:this._oCurrentPlant.plant_name,NewPlantName:t};$.ajax({url:l.getServiceUrl("plants/"),type:"PUT",contentType:"application/json",data:JSON.stringify(n),context:this}).done(this._onReceivingPlantNameRenamed).fail(d.getInstance().onReceiveErrorGeneric.bind(this,"Plant (PUT)"))},_onReceivingPlantNameRenamed:function(e,t,n){l.stopBusyDialog();s.show(e.message.message);r.getInstance().addMessageFromBackend(e.message);l.startBusyDialog("Loading...","Loading plants and images data");var a=d.getInstance();a.reloadPlantsFromBackend();a.resetImagesRegistry();this.requestImagesForPlant(this._oCurrentPlant.id);a.reloadTaxaFromBackend();this.applyToFragment("dialogRenamePlant",e=>e.close())},requestImagesForPlant:function(e){var t=encodeURIComponent(e);var n="plants/"+t+"/images/";$.ajax({url:l.getServiceUrl(n),context:this,async:true}).done(this._onReceivingImagesForPlant.bind(this,e)).fail(d.getInstance().onReceiveErrorGeneric.bind(this,"Plant Images (GET)"))},_onReceivingImagesForPlant:function(e,t,n,a){this.addPhotosToRegistry(t);this.getOwnerComponent().imagesPlantsLoaded.add(e);this.resetImagesCurrentPlant(e);this.getOwnerComponent().getModel("images").updateBindings()},onUploadPlantPhotosToServer:function(e){var t=this.byId("idPlantPhotoUpload");if(!t.getValue()){return}var n="plants/"+this._oCurrentPlant.id+"/images/";l.startBusyDialog("Uploading...","Image File(s)");var a=l.getServiceUrl(n);t.setUploadUrl(a);t.upload()},handleUploadPlantImagesComplete:function(e){var t=JSON.parse(e.getParameter("responseRaw"));if(!t){sMsg="Upload complete, but can't determine status.";r.getInstance().addMessage("Warning",sMsg,undefined,undefined)}r.getInstance().addMessageFromBackend(t.message);if(t.images.length>0){d.getInstance().addToImagesRegistry(t.images);this.resetImagesCurrentPlant(this._oCurrentPlant.id);this.getOwnerComponent().getModel("images").updateBindings()}l.stopBusyDialog();s.show(t.message.message)},onPressButtonCreateDescendantPlant:function(e){var n=this.getModifiedPlants();var a=this.getModifiedImages();var i=this.getModifiedTaxa();if(n.length!==0||a.length!==0||i.length!==0){s.show("There are unsaved changes. Save modified data or reload data first.");return}this.applyToFragment("dialogCreateDescendant",e=>{var n="seed (collected)";var a={propagationType:n,parentPlant:this.getPlantById(this._currentPlantId).plant_name,parentPlantPollen:undefined,descendantPlantName:undefined};var i=new t(a);e.setModel(i,"descendant");this.updatePlantNameSuggestion();e.open()})},onDescendantDialogCreate:function(e){var t=this.byId("dialogCreateDescendant").getModel("descendant").getData();if(!t.propagationType||!t.propagationType.length){s.show("Choose propagation type.");return}if(!t.parentPlant||!this.isPlantNameInPlantsModel(t.parentPlant)){s.show("Check parent plant.");return}var n=this.getSuggestionItem("propagationTypeCollection",t.propagationType);if(n.hasParentPlantPollen===true&&!!t.parentPlantPollen&&!this.isPlantNameInPlantsModel(t.parentPlantPollen)){s.show("Check parent plant pollen.");return}if(!t.descendantPlantName||!t.descendantPlantName.trim().length){s.show("Enter new plant name.");return}if(this.isPlantNameInPlantsModel(t.descendantPlantName)){s.show("Plant with that name already exists.");return}var a=this.getPlantByName(t.parentPlant);var i={id:undefined,plant_name:t.descendantPlantName,propagation_type:t.propagationType,taxon_id:n.hasParentPlantPollen?undefined:a.taxon_id,field_number:n.hasParentPlantPollen?"-":a.field_number,geographic_origin:n.hasParentPlantPollen?"-":a.geographic_origin,nursery_source:"-",last_update:undefined,descendant_plants_all:[],sibling_plants:[],same_taxon_plants:[],tags:[],parent_plant:{id:a.id,plant_name:a.plant_name,active:a.active},active:true};if(!!t.parentPlantPollen&&t.parentPlantPollen.length){var l=this.getPlantByName(t.parentPlantPollen);i.parent_plant_pollen={id:l.id,plant_name:t.parentPlantPollen,active:l.active}}this.saveNewPlant(i);this.applyToFragment("dialogCreateDescendant",e=>e.close())},_generatePlantNameWithRomanizedSuffix:function(e,t){for(var n=t;n<100;n++){var a=l.romanize(n);var i=e+" "+a;if(!this.isPlantNameInPlantsModel(i)){return i}}},_generateNewPlantNameSuggestion:function(e,t=undefined,n){if(!e||!e.trim().length){return}var a=this.getPlantByName(e);var i=n===true&&t&&t.trim().length;if(n===true&&!i){return undefined}if(i){var s=this.getPlantByName(t);var o=(a.botanical_name||e)+" × "+(s.botanical_name||t);if(this.isPlantNameInPlantsModel(o)){o=this._generatePlantNameWithRomanizedSuffix(o,2)}}else{var r=e;var d=/\sM{0,4}(CM|CD|D?C{0,3})(XC|XL|L?X{0,3})(IX|IV|V?I{0,3})$/;var g=r.match(d);if(!!g){var u=g.pop();var p=l.arabize(u)+1;r=r.substr(0,e.lastIndexOf(" "))}else{var p=2}var o=this._generatePlantNameWithRomanizedSuffix(r,p)}return o},updatePlantNameSuggestion:function(){if(!this.byId("autoNameDescendantPlantName").getSelected()){return}var e=this.byId("dialogCreateDescendant").getModel("descendant").getData();if(e.propagationType&&e.propagationType.length){var t=this.getSuggestionItem("propagationTypeCollection",e.propagationType)}var n=this._generateNewPlantNameSuggestion(e.parentPlant,e.parentPlantPollen,t.hasParentPlantPollen);this.byId("dialogCreateDescendant").getModel("descendant").setProperty("/descendantPlantName",n)},onDescendantDialogChangeParent:function(e,t){var n=e.getParameter("newValue").trim();if(!n||!this.isPlantNameInPlantsModel(n)){e.getSource().setValue(undefined);return}this.updatePlantNameSuggestion()},onDescendantDialogSwitchParents:function(){var e=this.byId("dialogCreateDescendant").getModel("descendant");var t=e.getProperty("/parentPlant");e.setProperty("/parentPlant",e.getProperty("/parentPlantPollen"));e.setProperty("/parentPlantPollen",t);this.updatePlantNameSuggestion()},onSwitchImageEditDescription:function(e){if(this.getView().getModel("status").getProperty("/images_editable")){this.getView().getModel("status").setProperty("/images_editable",false)}else{this.getView().getModel("status").setProperty("/images_editable",true)}}})},true);