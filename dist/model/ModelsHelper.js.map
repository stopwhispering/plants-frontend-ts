{"version":3,"file":"ModelsHelper.js","names":["MessageUtil","formatter","MessageType","ModelsHelper","ManagedObject","constructor","component","_component","getModel","attachRequestCompleted","_onReceivingPlantsFromBackend","bind","attachRequestFailed","onReceiveErrorGeneric","_onReceivingTaxaFromBackend","sCaller","error","result","statusText","Util","stopBusyDialog","responseJSON","detail","type","getInstance","addMessageFromBackend","MessageToast","show","message","oErrorEvent","getParameter","sMsg","status","addMessage","Error","oRequestInfo","oPlantsModel","getSource","oPlantsDataClone","getClonedObject","getData","sresource","parse_resource_from_url","Information","undefined","oTaxonModel","oTaxonDataClone","reloadPlantsFromBackend","sUrl","getServiceUrl","loadData","resetImagesRegistry","imagesRegistry","imagesRegistryClone","imagesPlantsLoaded","Set","updateBindings","addToImagesRegistry","aImages","forEach","oImage","sKey","reloadTaxaFromBackend","reloadKeywordProposalsFromBackend","setModel","JSONModel","reloadNurserySourceProposalsFromBackend","oModel","setSizeLimit","reloadPropertyNamesFromBackend","_instance"],"sources":["../../src/model/ModelsHelper.ts"],"sourcesContent":["import JSONModel from \"sap/ui/model/json/JSONModel\";\r\nimport MessageUtil from \"plants/ui/customClasses/MessageUtil\";\r\nimport * as Util from \"plants/ui/customClasses/Util\";\r\nimport MessageToast from \"sap/m/MessageToast\";\r\nimport ManagedObject from \"sap/ui/base/ManagedObject\";\r\nimport formatter from \"plants/ui/model/formatter\";\r\nimport Component from \"../Component\";\r\nimport { MessageType } from \"sap/ui/core/library\";\r\nimport Event from \"sap/ui/base/Event\";\r\nimport { PImage } from \"../definitions/ImageFromBackend\";\r\n\r\n/**\r\n * @namespace plants.ui.model\r\n */\r\nexport default class ModelsHelper extends ManagedObject {\r\n\tprivate static _instance: ModelsHelper;\r\n\tprivate formatter = new formatter();\r\n\tprivate _component;\r\n\t\r\n\tpublic static getInstance(component?: Component) {\r\n\t\tif (!ModelsHelper._instance && !!component) {\r\n\t\t\tModelsHelper._instance = new ModelsHelper(component);\r\n\t\t}\r\n\t\treturn ModelsHelper._instance;\r\n\t}\r\n\r\n\tconstructor(component: Component) {\r\n\t\tsuper();\r\n\t\tthis._component = component;\r\n\t\t//we need to add the event handlers to the jsonmodel here as this is executed only\r\n\t\t//once; if we attach them before calling, they're adding up to one more each time\r\n\t\tthis._component.getModel('plants').attachRequestCompleted(this._onReceivingPlantsFromBackend.bind(this));\r\n\t\tthis._component.getModel('plants').attachRequestFailed(this.onReceiveErrorGeneric.bind(this, 'Plants Model'));\r\n\r\n\t\tthis._component.getModel('taxon').attachRequestCompleted(this._onReceivingTaxaFromBackend.bind(this));\r\n\t\tthis._component.getModel('taxon').attachRequestFailed(this.onReceiveErrorGeneric.bind(this, 'Taxon Model'));\r\n\t}\r\n\r\n\tonReceiveErrorGeneric(sCaller: string, error: JQueryXHR, result?: string, statusText?: string) {\r\n\t\t//trying to catch all kinds of error callback returns\r\n\t\t//always declare similar to: .fail(this.ModelsHelper.getInstance()._onReceiveErrorGeneric.bind(thisOrOtherContext,'EventsResource'));\r\n\t\tUtil.stopBusyDialog();\r\n\r\n\r\n\t\t//fastapi manually thrown exceptions (default)\r\n\t\tif ((!!error) && (!!error.responseJSON) && (!!error.responseJSON.detail) && (!!error.responseJSON.detail.type)) {\r\n\t\t\tMessageUtil.getInstance().addMessageFromBackend(error.responseJSON.detail);\r\n\t\t\tMessageToast.show(error.responseJSON.detail.type + ': ' + error.responseJSON.detail.message);\r\n\t\t\treturn;\r\n\t\t};\r\n\r\n\t\t//server not reachable\r\n\t\tconst oErrorEvent: Event = <unknown>error as Event;\r\n\t\tif (!!oErrorEvent.getParameter && oErrorEvent.getParameter('message')){\r\n\t\t\tconst sMsg = 'Error at ' + sCaller + ' - Could not reach Server (Error: ' + error.status + ' ' + error.statusText + ')'\r\n\t\t\tMessageUtil.getInstance().addMessage(MessageType.Error, sMsg);\r\n\t\t\tMessageToast.show(sMsg);\r\n\t\t\treturn;\r\n\t\t};\r\n\r\n\t\t//fastapi unexpected error (e.g. pydantic validation error)\r\n\t\tif (!!error && !error.responseJSON){\r\n\t\t\tconst sMsg = 'Error at ' + sCaller + ' - Unexpected Backend Error (Error: ' + error.status + ' ' + error.statusText + ')'\r\n\t\t\tMessageUtil.getInstance().addMessage(MessageType.Error, sMsg);\r\n\t\t\tMessageToast.show(sMsg);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tMessageToast.show('Unknown Error. See onReceiveErrorGeneric and handle.');\r\n\r\n\t\t// // general http error handler\t\t\t\r\n\t\t// //tested for ..\r\n\t\t// if (error && error.hasOwnProperty('responseJSON') && typeof (error.responseJSON) === 'string') {\r\n\t\t// \tvar sMsg = 'Error: ' + error.status + ' ' + error.responseJSON;\r\n\t\t// }\r\n\r\n\t\t// //     - reloadImagesFromBackend (ajax; manually raised)\r\n\t\t// else if (error && error.hasOwnProperty('responseJSON') && error.responseJSON && 'error' in error.responseJSON) {\r\n\t\t// \tsMsg = 'Error: ' + error.status + ' ' + error.responseJSON['error'];\r\n\r\n\t\t// \t//     - reloadPlantsFromBackend(jsonmodel; manually raised)\r\n\t\t// } else if (error && error.getParameter && (!!error.getParameter('responseText')) && typeof (JSON.parse(error.getParameter('responseText'))) === 'object') {\r\n\t\t// \tvar oParams = error.getParameters();\r\n\t\t// \tsMsg = 'Error: ' + oParams.statusCode + ' ' + JSON.parse(oParams.responseText).error;\r\n\r\n\t\t// \t// fallback solution for ajax calls (e.g. server stopped working) \r\n\t\t// } else if (!!error.status && !!error.statusText) {\r\n\t\t// \tsMsg = 'Error at: ' + sCaller + ' - Status: ' + error.status + ' ' + error.statusText;\r\n\r\n\t\t// \t// fallback solution for jsonmodel calls (e.g. server stopped working) \r\n\t\t// } else {\r\n\t\t// \tsMsg = 'Error at: ' + sCaller;\r\n\t\t// }\r\n\r\n\t\t// MessageToast.show(sMsg);\r\n\t\t// MessageUtil.getInstance().addMessage(MessageType.Error, sMsg, undefined, undefined);\r\n\t}\r\n\r\n\tprivate _onReceivingPlantsFromBackend(oRequestInfo: Event) {\r\n\t\t// create new clone objects to track changes\r\n\t\tconst oPlantsModel = <JSONModel>oRequestInfo.getSource();\r\n\t\tthis._component.oPlantsDataClone = Util.getClonedObject(oPlantsModel.getData());\r\n\r\n\t\t//create message\r\n\t\tvar sresource = Util.parse_resource_from_url(oRequestInfo.getParameter('url'));\r\n\t\tMessageUtil.getInstance().addMessage(MessageType.Information, 'Loaded Plants from backend', undefined,\r\n\t\t\t'Resource: ' + sresource);\r\n\t}\r\n\r\n\tprivate _onReceivingTaxaFromBackend(oRequestInfo: Event) {\r\n\t\t// create new clone objects to track changes\r\n\t\tconst oTaxonModel = <JSONModel>oRequestInfo.getSource();\r\n\t\tthis._component.oTaxonDataClone = Util.getClonedObject(oTaxonModel.getData());\r\n\r\n\t\t//create message\r\n\t\tvar sresource = Util.parse_resource_from_url(oRequestInfo.getParameter('url'));\r\n\t\tMessageUtil.getInstance().addMessage(MessageType.Information, 'Loaded Taxa from backend', undefined,\r\n\t\t\t'Resource: ' + sresource);\r\n\t}\r\n\r\n\treloadPlantsFromBackend() {\r\n\t\tvar sUrl = Util.getServiceUrl('plants/');\r\n\t\tthis._component.getModel('plants').loadData(sUrl);\r\n\t\tUtil.stopBusyDialog();  // todo: should be stopped only when everything has been reloaded, not only plants\r\n\t}\r\n\r\n\tresetImagesRegistry() {\r\n\t\tthis._component.imagesRegistry = {};\r\n\t\tthis._component.imagesRegistryClone = {};\r\n\t\tthis._component.imagesPlantsLoaded = new Set();\r\n\t\tthis._component.getModel('images').updateBindings(false);\r\n\t\tthis._component.getModel('untaggedImages').updateBindings(false);\r\n\t}\r\n\r\n\taddToImagesRegistry(aImages: PImage[]) {\r\n\t\t// after uploading new images, add them to the  registry\r\n\t\taImages.forEach(oImage => {\r\n\t\t\tvar sKey = oImage['filename'];\r\n\t\t\tif (!(sKey in this._component.imagesRegistry)) {\r\n\t\t\t\tthis._component.imagesRegistry[sKey] = oImage;\r\n\t\t\t}\r\n\t\t\tthis._component.imagesRegistryClone[sKey] = Util.getClonedObject(oImage);\r\n\t\t});\r\n\t}\r\n\r\n\treloadTaxaFromBackend() {\r\n\t\t//reload taxon data\r\n\t\tvar sUrl = Util.getServiceUrl('taxa/');\r\n\t\tthis._component.getModel('taxon').loadData(sUrl);\r\n\t}\r\n\r\n\treloadKeywordProposalsFromBackend() {\r\n\t\t// get keywords collection from backend proposals resource\r\n\t\tvar sUrl = Util.getServiceUrl('proposals/KeywordProposals');\r\n\t\tif (!this._component.getModel('keywords')) {\r\n\t\t\tthis._component.setModel(new JSONModel(sUrl), 'keywords');\r\n\t\t} else {\r\n\t\t\tthis._component.getModel('keywords').loadData(sUrl);\r\n\t\t}\r\n\t}\r\n\r\n\treloadNurserySourceProposalsFromBackend() {\r\n\t\tvar sUrl = Util.getServiceUrl('proposals/NurserySourceProposals');\r\n\t\tif (!this._component.getModel('nurseries_sources')) {\r\n\t\t\tvar oModel = new JSONModel(sUrl);\r\n\t\t\toModel.setSizeLimit(50);\r\n\t\t\tthis._component.setModel(oModel, 'nurseries_sources');\r\n\t\t} else {\r\n\t\t\tthis._component.getModel('nurseries_sources').loadData(sUrl);\r\n\t\t}\r\n\t}\r\n\r\n\treloadPropertyNamesFromBackend() {\r\n\t\t// get property names with their categories from backend\r\n\t\tvar sUrl = Util.getServiceUrl('property_names/');\r\n\t\tif (!this._component.getModel('propertyNames')) {\r\n\t\t\tvar oModel = new JSONModel(sUrl);\r\n\t\t\toModel.setSizeLimit(300);\r\n\t\t\tthis._component.setModel(oModel, 'propertyNames');\r\n\t\t} else {\r\n\t\t\tthis._component.getModel('propertyNames').loadData(sUrl);\r\n\t\t}\r\n\t}\r\n\r\n}"],"mappings":"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"}