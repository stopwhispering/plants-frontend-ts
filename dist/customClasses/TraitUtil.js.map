{"version":3,"file":"TraitUtil.js","names":["TraitUtil","ManagedObject","onEditTraitPressRemoveTrait","evt","applyToFragment","o","sPathTrait","getBindingContext","getPath","sPathCategory","substr","indexOf","oModel","getModel","oCategory","getProperty","oTrait","getObject","iIndex","traits","splice","updateBindings","close","onBtnChangeTraitType","sStatus","_oEditTraitFragment","status","onPressTrait","getSource","bindElement","path","model","openBy","onPressAddTrait","sTraitCategoryKey","byId","getSelectedKey","sTraitCategory","_getSelectedItemText","sTrait","getValue","trim","length","MessageToast","show","oTaxon","getView","trait_categories","oCatFound","find","oCatSearch","id","toString","oTraitFound","oTraitSearch","trait","category_name","push","dNewTrait","undefined","onLiveChangeNewTraitTrait","oInput","aFilters","getBinding","aApplicationFilters","sSelectedCategoryKey","_filterNewTraitInputPropopsalsByTraitCategory","onChangeNewTraitCategory","oSelectedItem","getParameter","sTraitCategoryId","Filter","operator","FilterOperator","EQ","value1","oBinding","filter","FilterType","Application","getInstance","_instance"],"sources":["../../src/customClasses/TraitUtil.ts"],"sourcesContent":["import MessageToast from \"sap/m/MessageToast\"\r\nimport FilterType from \"sap/ui/model/FilterType\"\r\nimport Filter from \"sap/ui/model/Filter\"\r\nimport FilterOperator from \"sap/ui/model/FilterOperator\"\r\nimport ManagedObject from \"sap/ui/base/ManagedObject\"\r\n\r\n/**\r\n * @namespace plants.ui.customClasses\r\n */\r\nexport default class TraitUtil extends ManagedObject {\r\n\tprivate static _instance: TraitUtil;\r\n\r\n\tpublic static getInstance(): TraitUtil {\r\n\t\tif (!TraitUtil._instance) {\r\n\t\t\tTraitUtil._instance = new TraitUtil();\r\n\t\t}\r\n\t\treturn TraitUtil._instance;\r\n\t}\r\n\t\r\n\tonEditTraitPressRemoveTrait(evt: Event) {\r\n\t\t// triggered in fragment to eddit or delete trait\r\n\t\t// removes the trait from plant's taxon in the taxon model\r\n\r\n\t\t// get the trait's category\r\n\t\tthis.applyToFragment('dialogEditTrait', (o) => {\r\n\t\t\tvar sPathTrait = o.getBindingContext('taxon').getPath();\r\n\t\t\tvar sPathCategory = sPathTrait.substr(0, sPathTrait.indexOf('/traits/'));\r\n\t\t\tvar oModel = o.getModel('taxon');\r\n\t\t\tvar oCategory = oModel.getProperty(sPathCategory);\r\n\r\n\t\t\t// get index of the trait to be deleted among the category's traits\r\n\t\t\tvar oTrait = o.getBindingContext('taxon').getObject();\r\n\t\t\tvar iIndex = oCategory.traits.indexOf(oTrait);\r\n\r\n\t\t\t// remove the trait from the lits of the category's traits\r\n\t\t\toCategory.traits.splice(iIndex, 1);\r\n\t\t\toModel.updateBindings(false);\r\n\r\n\t\t\to.close();\r\n\t\t});\r\n\t}\r\n\r\n\tonBtnChangeTraitType(sStatus, evt) {\r\n\t\t// triggered by selecting one of the trait type buttons in the trait edit popover\r\n\t\tvar oTrait = this._oEditTraitFragment.getBindingContext('taxon').getObject();\r\n\t\toTrait.status = sStatus;\r\n\t\t// re-apply formatter function to trait's objectstatus \r\n\t\tthis.applyToFragment('dialogEditTrait', (o) => {\r\n\t\t\to.getModel('taxon').updateBindings(false);\r\n\t\t\to.close();\r\n\t\t});\r\n\t}\r\n\r\n\tonPressTrait(evt: Event) {\r\n\t\t// show fragment to edit or delete trait\r\n\t\tvar oTrait = evt.getSource();  // for closure\r\n\t\tvar sPathTrait = oTrait.getBindingContext('taxon').getPath();\r\n\r\n\t\tthis.applyToFragment('dialogEditTrait', (o) => {\r\n\t\t\to.bindElement({\r\n\t\t\t\tpath: sPathTrait,\r\n\t\t\t\tmodel: \"taxon\"\r\n\t\t\t});\r\n\t\t\to.openBy(oTrait);\r\n\t\t});\r\n\t}\r\n\r\n\tonPressAddTrait(evt: Event) {\r\n\t\t// triggered by add button for new trait in traits fragment\r\n\t\t// after validation, add trait to internal model\r\n\t\t// trait is added to db in backend only upon saving\r\n\t\t// additionally, we add the trait to the proposals model\r\n\r\n\t\tvar sTraitCategoryKey = this.byId('newTraitCategory').getSelectedKey();\r\n\t\tvar sTraitCategory = this.byId('newTraitCategory')._getSelectedItemText();\r\n\t\tvar sTrait = this.byId('newTraitTrait').getValue().trim();\r\n\t\t// var bObserved = this.byId('newTraitObserved').getSelected();\r\n\t\tvar sStatus = this.byId('newTraitStatus').getSelectedKey();\r\n\r\n\r\n\t\t// check if empty \r\n\t\tif (sTrait.length === 0) {\r\n\t\t\tMessageToast.show('Enter trait first.');\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// check if same-text trait already exists for that taxon\r\n\t\tvar oTaxon = this.getView().getBindingContext('taxon').getObject();\r\n\r\n\t\tif (oTaxon.trait_categories) {\r\n\t\t\tvar oCatFound = oTaxon.trait_categories.find(function (oCatSearch) {\r\n\t\t\t\treturn oCatSearch.id.toString() === sTraitCategoryKey;\r\n\t\t\t});\r\n\r\n\t\t\tif (oCatFound) {\r\n\t\t\t\tvar oTraitFound = oCatFound.traits.find(function (oTraitSearch) {\r\n\t\t\t\t\treturn oTraitSearch.trait === sTrait;\r\n\t\t\t\t});\r\n\r\n\t\t\t\tif (oTraitFound) {\r\n\t\t\t\t\tMessageToast.show('Trait already assigned.');\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// create trait category object within taxon if required\r\n\t\tif (!oTaxon.trait_categories) {\r\n\t\t\toTaxon.trait_categories = [];\r\n\t\t}\r\n\r\n\t\tif (!oCatFound) {\r\n\t\t\toCatFound = {\r\n\t\t\t\tid: sTraitCategoryKey,\r\n\t\t\t\tcategory_name: sTraitCategory\r\n\t\t\t};\r\n\t\t\toTaxon.trait_categories.push(oCatFound);\r\n\t\t}\r\n\r\n\t\t// create new trait object in taxon model\r\n\t\tvar dNewTrait = {\r\n\t\t\tid: undefined,\r\n\t\t\tstatus: sStatus,\r\n\t\t\t// observed: bObserved,\r\n\t\t\ttrait: sTrait\r\n\t\t};\r\n\t\tif (oCatFound.traits) {\r\n\t\t\toCatFound.traits.push(dNewTrait);\r\n\t\t} else {\r\n\t\t\toCatFound.traits = [dNewTrait];\r\n\t\t}\r\n\r\n\t\tthis.getView().getBindingContext('taxon').getModel().updateBindings(false);\r\n\t}\r\n\r\n\tonLiveChangeNewTraitTrait(evt: Event) {\r\n\t\t// as we set the filter on the trait proposals in the category change event (see\r\n\t\t// onChangeNewTraitCategory), we have a problem with the initially selected category;\r\n\t\t// we can't set the filter in this controller's initialization as the proposals are\r\n\t\t// loaded async. we could use a promise, but we're going the easy way here and set the\r\n\t\t// initial filter upon entering something in the traits input for the first time\r\n\t\tvar oInput = evt.getSource();\r\n\t\tvar aFilters = oInput.getBinding(\"suggestionItems\").aApplicationFilters;\r\n\t\tvar sSelectedCategoryKey = this.byId('newTraitCategory').getSelectedKey();\r\n\r\n\t\tif (aFilters.length === 0 && !!sSelectedCategoryKey) {\r\n\t\t\tthis.TraitUtil._filterNewTraitInputPropopsalsByTraitCategory(sSelectedCategoryKey);\r\n\t\t}\r\n\t}\r\n\r\n\tonChangeNewTraitCategory(evt: Event) {\r\n\t\t// triggered by selecting/chaning category for new trait in traits fragment\r\n\t\t// here, we filter the proposals in the traits input on the selected category's traits\r\n\t\t// get category selectd\r\n\t\tvar oSelectedItem = evt.getParameter('selectedItem');\r\n\t\tvar sSelectedCategoryKey = oSelectedItem.getProperty('key');\r\n\t\tthis.TraitUtil._filterNewTraitInputPropopsalsByTraitCategory(sSelectedCategoryKey);\r\n\t}\r\n\r\n\t_filterNewTraitInputPropopsalsByTraitCategory(sTraitCategoryId) {\r\n\t\t// filter suggestion items for trait input on selected category \r\n\t\tvar aFilters = [\r\n\t\t\tnew Filter({\r\n\t\t\t\tpath: \"trait_category_id\",\r\n\t\t\t\toperator: FilterOperator.EQ,\r\n\t\t\t\tvalue1: sTraitCategoryId\r\n\t\t\t})\r\n\t\t];\r\n\t\tvar oBinding = this.getView().byId(\"newTraitTrait\").getBinding(\"suggestionItems\");\r\n\t\toBinding.filter(aFilters, FilterType.Application);\r\n\t}\r\n}"],"mappings":";EAMA;AACA;AACA;EAFA,MAGqBA,SAAS,GAASC,aAAa;IAUnDC,2BAA2B,wCAACC,GAAU,EAAE;MACvC;MACA;;MAEA;MACA,IAAI,CAACC,eAAe,CAAC,iBAAiB,EAAGC,CAAC,IAAK;QAC9C,IAAIC,UAAU,GAAGD,CAAC,CAACE,iBAAiB,CAAC,OAAO,CAAC,CAACC,OAAO,EAAE;QACvD,IAAIC,aAAa,GAAGH,UAAU,CAACI,MAAM,CAAC,CAAC,EAAEJ,UAAU,CAACK,OAAO,CAAC,UAAU,CAAC,CAAC;QACxE,IAAIC,MAAM,GAAGP,CAAC,CAACQ,QAAQ,CAAC,OAAO,CAAC;QAChC,IAAIC,SAAS,GAAGF,MAAM,CAACG,WAAW,CAACN,aAAa,CAAC;;QAEjD;QACA,IAAIO,MAAM,GAAGX,CAAC,CAACE,iBAAiB,CAAC,OAAO,CAAC,CAACU,SAAS,EAAE;QACrD,IAAIC,MAAM,GAAGJ,SAAS,CAACK,MAAM,CAACR,OAAO,CAACK,MAAM,CAAC;;QAE7C;QACAF,SAAS,CAACK,MAAM,CAACC,MAAM,CAACF,MAAM,EAAE,CAAC,CAAC;QAClCN,MAAM,CAACS,cAAc,CAAC,KAAK,CAAC;QAE5BhB,CAAC,CAACiB,KAAK,EAAE;MACV,CAAC,CAAC;IACH,CAAC;IAEDC,oBAAoB,iCAACC,OAAO,EAAErB,GAAG,EAAE;MAClC;MACA,IAAIa,MAAM,GAAG,IAAI,CAACS,mBAAmB,CAAClB,iBAAiB,CAAC,OAAO,CAAC,CAACU,SAAS,EAAE;MAC5ED,MAAM,CAACU,MAAM,GAAGF,OAAO;MACvB;MACA,IAAI,CAACpB,eAAe,CAAC,iBAAiB,EAAGC,CAAC,IAAK;QAC9CA,CAAC,CAACQ,QAAQ,CAAC,OAAO,CAAC,CAACQ,cAAc,CAAC,KAAK,CAAC;QACzChB,CAAC,CAACiB,KAAK,EAAE;MACV,CAAC,CAAC;IACH,CAAC;IAEDK,YAAY,yBAACxB,GAAU,EAAE;MACxB;MACA,IAAIa,MAAM,GAAGb,GAAG,CAACyB,SAAS,EAAE,CAAC,CAAE;MAC/B,IAAItB,UAAU,GAAGU,MAAM,CAACT,iBAAiB,CAAC,OAAO,CAAC,CAACC,OAAO,EAAE;MAE5D,IAAI,CAACJ,eAAe,CAAC,iBAAiB,EAAGC,CAAC,IAAK;QAC9CA,CAAC,CAACwB,WAAW,CAAC;UACbC,IAAI,EAAExB,UAAU;UAChByB,KAAK,EAAE;QACR,CAAC,CAAC;QACF1B,CAAC,CAAC2B,MAAM,CAAChB,MAAM,CAAC;MACjB,CAAC,CAAC;IACH,CAAC;IAEDiB,eAAe,4BAAC9B,GAAU,EAAE;MAC3B;MACA;MACA;MACA;;MAEA,IAAI+B,iBAAiB,GAAG,IAAI,CAACC,IAAI,CAAC,kBAAkB,CAAC,CAACC,cAAc,EAAE;MACtE,IAAIC,cAAc,GAAG,IAAI,CAACF,IAAI,CAAC,kBAAkB,CAAC,CAACG,oBAAoB,EAAE;MACzE,IAAIC,MAAM,GAAG,IAAI,CAACJ,IAAI,CAAC,eAAe,CAAC,CAACK,QAAQ,EAAE,CAACC,IAAI,EAAE;MACzD;MACA,IAAIjB,OAAO,GAAG,IAAI,CAACW,IAAI,CAAC,gBAAgB,CAAC,CAACC,cAAc,EAAE;;MAG1D;MACA,IAAIG,MAAM,CAACG,MAAM,KAAK,CAAC,EAAE;QACxBC,YAAY,CAACC,IAAI,CAAC,oBAAoB,CAAC;QACvC;MACD;;MAEA;MACA,IAAIC,MAAM,GAAG,IAAI,CAACC,OAAO,EAAE,CAACvC,iBAAiB,CAAC,OAAO,CAAC,CAACU,SAAS,EAAE;MAElE,IAAI4B,MAAM,CAACE,gBAAgB,EAAE;QAC5B,IAAIC,SAAS,GAAGH,MAAM,CAACE,gBAAgB,CAACE,IAAI,CAAC,UAAUC,UAAU,EAAE;UAClE,OAAOA,UAAU,CAACC,EAAE,CAACC,QAAQ,EAAE,KAAKlB,iBAAiB;QACtD,CAAC,CAAC;QAEF,IAAIc,SAAS,EAAE;UACd,IAAIK,WAAW,GAAGL,SAAS,CAAC7B,MAAM,CAAC8B,IAAI,CAAC,UAAUK,YAAY,EAAE;YAC/D,OAAOA,YAAY,CAACC,KAAK,KAAKhB,MAAM;UACrC,CAAC,CAAC;UAEF,IAAIc,WAAW,EAAE;YAChBV,YAAY,CAACC,IAAI,CAAC,yBAAyB,CAAC;YAC5C;UACD;QACD;MACD;;MAEA;MACA,IAAI,CAACC,MAAM,CAACE,gBAAgB,EAAE;QAC7BF,MAAM,CAACE,gBAAgB,GAAG,EAAE;MAC7B;MAEA,IAAI,CAACC,SAAS,EAAE;QACfA,SAAS,GAAG;UACXG,EAAE,EAAEjB,iBAAiB;UACrBsB,aAAa,EAAEnB;QAChB,CAAC;QACDQ,MAAM,CAACE,gBAAgB,CAACU,IAAI,CAACT,SAAS,CAAC;MACxC;;MAEA;MACA,IAAIU,SAAS,GAAG;QACfP,EAAE,EAAEQ,SAAS;QACbjC,MAAM,EAAEF,OAAO;QACf;QACA+B,KAAK,EAAEhB;MACR,CAAC;MACD,IAAIS,SAAS,CAAC7B,MAAM,EAAE;QACrB6B,SAAS,CAAC7B,MAAM,CAACsC,IAAI,CAACC,SAAS,CAAC;MACjC,CAAC,MAAM;QACNV,SAAS,CAAC7B,MAAM,GAAG,CAACuC,SAAS,CAAC;MAC/B;MAEA,IAAI,CAACZ,OAAO,EAAE,CAACvC,iBAAiB,CAAC,OAAO,CAAC,CAACM,QAAQ,EAAE,CAACQ,cAAc,CAAC,KAAK,CAAC;IAC3E,CAAC;IAEDuC,yBAAyB,sCAACzD,GAAU,EAAE;MACrC;MACA;MACA;MACA;MACA;MACA,IAAI0D,MAAM,GAAG1D,GAAG,CAACyB,SAAS,EAAE;MAC5B,IAAIkC,QAAQ,GAAGD,MAAM,CAACE,UAAU,CAAC,iBAAiB,CAAC,CAACC,mBAAmB;MACvE,IAAIC,oBAAoB,GAAG,IAAI,CAAC9B,IAAI,CAAC,kBAAkB,CAAC,CAACC,cAAc,EAAE;MAEzE,IAAI0B,QAAQ,CAACpB,MAAM,KAAK,CAAC,IAAI,CAAC,CAACuB,oBAAoB,EAAE;QACpD,IAAI,CAACjE,SAAS,CAACkE,6CAA6C,CAACD,oBAAoB,CAAC;MACnF;IACD,CAAC;IAEDE,wBAAwB,qCAAChE,GAAU,EAAE;MACpC;MACA;MACA;MACA,IAAIiE,aAAa,GAAGjE,GAAG,CAACkE,YAAY,CAAC,cAAc,CAAC;MACpD,IAAIJ,oBAAoB,GAAGG,aAAa,CAACrD,WAAW,CAAC,KAAK,CAAC;MAC3D,IAAI,CAACf,SAAS,CAACkE,6CAA6C,CAACD,oBAAoB,CAAC;IACnF,CAAC;IAEDC,6CAA6C,yDAACI,gBAAgB,EAAE;MAC/D;MACA,IAAIR,QAAQ,GAAG,CACd,IAAIS,MAAM,CAAC;QACVzC,IAAI,EAAE,mBAAmB;QACzB0C,QAAQ,EAAEC,cAAc,CAACC,EAAE;QAC3BC,MAAM,EAAEL;MACT,CAAC,CAAC,CACF;MACD,IAAIM,QAAQ,GAAG,IAAI,CAAC9B,OAAO,EAAE,CAACX,IAAI,CAAC,eAAe,CAAC,CAAC4B,UAAU,CAAC,iBAAiB,CAAC;MACjFa,QAAQ,CAACC,MAAM,CAACf,QAAQ,EAAEgB,UAAU,CAACC,WAAW,CAAC;IAClD;EAAC;EAjKmB/E,SAAS,CAGfgF,WAAW,YAAXA,WAAW,GAAc;IACtC,IAAI,CAAChF,SAAS,CAACiF,SAAS,EAAE;MACzBjF,SAAS,CAACiF,SAAS,GAAG,IAAIjF,SAAS,EAAE;IACtC;IACA,OAAOA,SAAS,CAACiF,SAAS;EAC3B,CAAC;EAAA,OARmBjF,SAAS;AAAA"}