sap.ui.define(["plants/ui/customClasses/Util","sap/m/MessageToast","sap/ui/model/json/JSONModel","sap/ui/layout/Grid","sap/ui/layout/GridData","sap/m/CustomListItem","sap/ui/base/ManagedObject","../model/ModelsHelper"],function(e,t,i,n,o,s,a,d){function l(e){return e&&e.__esModule&&typeof e.default!=="undefined"?e.default:e}const r=l(d);const c=a.extend("plants.ui.customClasses.EventsUtil",{constructor:function e(t,i){a.prototype.constructor.call(this);this.modelsHelper=r.getInstance();this.applyToFragment=t;this.oSuggestionsData=i},eventsListFactory:function e(t,i){let a=this;var d=i.getPath();var l=i.getObject();var r=new s({});r.addStyleClass("sapUiTinyMarginBottom");var c=new n({defaultSpan:"XL3 L3 M6 S12"});r.addContent(c);var p=a.byId("eventHeader").clone(t);c.addContent(p);if(!!l.observation){var v=a.byId("eventObservation").clone(t);c.addContent(v)}if(!!l.pot){var g=a.byId("eventPot").clone(t);c.addContent(g)}if(!!l.soil){var h=a.byId("eventSoil").clone(t);c.addContent(h)}var u=c.getContent().length*3-1;if(12-u<3){var f="XL12 L12"}else{f="XL"+(12-u)+" L"+(12-u)}var m=f+" M6 S12";var _=a.byId("eventImageListItem").clone(t);var b=a.byId("eventImageContainer").clone(t);b.bindAggregation("items",{path:"events>"+d+"/images",template:_,templateShareable:false});b.setLayoutData(new o({span:m}));c.addContent(b);return r},deleteEventsTableRow:function e(i,n,o){var s=n.getProperty("/PlantsEventsDict/"+o.id);var a=s.indexOf(i);if(a<0){t.show("An error happended in internal processing of deletion.");return}s.splice(a,1);n.refresh()},_getObservationData:function e(t){if(!t.segments.observation)return null;const i=JSON.parse(JSON.stringify(t.observation));if(i.height===0){i.height=undefined}if(i.stem_max_diameter===0){i.stem_max_diameter=undefined}if(!i.diseases||i.diseases.length===0){i.diseases=undefined}if(!i.observation_notes||i.observation_notes===0){i.observation_notes=undefined}return i},_getPotData:function e(t,i){if(!t.segments.pot)return null;const n=JSON.parse(JSON.stringify(t.pot));if(i.byId("idPotHeight0").getSelected()){n.shape_side="very flat"}else if(i.byId("idPotHeight1").getSelected()){n.shape_side="flat"}else if(i.byId("idPotHeight2").getSelected()){n.shape_side="high"}else if(i.byId("idPotHeight3").getSelected()){n.shape_side="very high"}else{throw new Error("Pot height not selected")}if(i.byId("idPotShape0").getSelected()){n.shape_top="square"}else if(i.byId("idPotShape1").getSelected()){n.shape_top="round"}else if(i.byId("idPotShape2").getSelected()){n.shape_top="oval"}else if(i.byId("idPotShape3").getSelected()){n.shape_top="hexagonal"}else{throw new Error("Pot shape not selected")}return n},_getSoilData:function e(t,i){if(!t.segments.soil)return null;const n=JSON.parse(JSON.stringify(t.soil));if(!n.description||n.description.length==0){n.description=undefined}return n},_loadSoils:function t(n){var o=e.getServiceUrl("events/soils");let s=n.getModel("soils");if(!s){s=new i(o);n.setModel(s,"soils")}else{s.loadData(o)}},_addEvent:function i(n,o,s){const a=n.byId("dialogEvent");const d=a.getModel("editOrNewEvent");const l=d.getData();e.assertCorrectDate(l.date);this._assertNoDuplicateOnDate(s,l.date);const r=e.getClonedObject(l);if(r.segments.soil&&(!r.soil||!r.soil.id)){t.show("Please choose soil first.");return}const c=this._getObservationData(r);const p=this._getPotData(r,n);const v=this._getSoilData(r,n);const g={date:r.date,event_notes:r.event_notes,observation:c,pot:p,soil:v,plant_id:r.plant_id,images:[]};s.push(g);o.updateBindings(false);a.close()},_assertNoDuplicateOnDate:function e(i,n,o){const s=i.find(function(e){return e.date===n&&e!==o});if(!!s){t.show("Duplicate event on that date.");throw new Error("Duplicate event on that date.")}},_editEvent:function i(n,o,s){const a=n.byId("dialogEvent");const d=a.getModel("editOrNewEvent");const l=d.getData();if(!l.oldEvent){t.show("Can't determine old record. Aborting.");return}const r=l.oldEvent;e.assertCorrectDate(l.date);this._assertNoDuplicateOnDate(s,l.date,r);if(r.plant_id!==l.plant_id){t.show("Plant ID cannot be changed.");throw new Error("Plant ID cannot be changed.")}if(l.segments.soil&&(!l.soil||!l.soil.id)){t.show("Please choose soil first.");return}const c=this._getObservationData(l);const p=this._getPotData(l,n);const v=this._getSoilData(l,n);r.date=l.date;r.event_notes=l.event_notes&&l.event_notes.length>0?l.event_notes:undefined;const g=c?c.id:undefined;r.observation=c;if(r.observation)r.observation.id=g;r.pot=p;r.soil=v;o.updateBindings(false);o.refresh(true);a.close()},addOrEditEvent:function e(t,i){var n=t.byId("dialogEvent");var o=n.getModel("editOrNewEvent");var s=o.getData();var a=s.mode;var d=t.getModel("events");var l="/PlantsEventsDict/"+i.id+"/";var r=d.getProperty(l);if(a==="edit"){this._editEvent(t,d,r)}else{this._addEvent(t,d,r)}},editEvent:function e(t,i,n){this.applyToFragment("dialogEvent",this._initEditSelectedEvent.bind(this,t,i,n))},_initEditSelectedEvent:function t(n,o,s,a){this._loadSoils(o);a.setTitle("Edit Event ("+n.date+")");o.byId("btnEventUpdateSave").setText("Update");var d=this._getInitialEvent(s);d.mode="edit";d.date=n.date;d.event_notes=n.event_notes;d.oldEvent=n;if(n.pot&&n.pot.id){d.pot.id=n.pot.id}if(n.observation&&n.observation.id){d.observation.id=n.observation.id}if(!!n.observation){d.segments.observation=true;d.observation.diseases=n.observation.diseases;d.observation.height=n.observation.height;d.observation.observation_notes=n.observation.observation_notes;d.observation.stem_max_diameter=n.observation.stem_max_diameter}else{d.segments.observation=false}if(!!n.pot){d.segments.pot=true;d.pot.diameter_width=n.pot.diameter_width;d.pot.material=n.pot.material;switch(n.pot.shape_side){case"very flat":o.byId("idPotHeight0").setSelected(true);break;case"flat":o.byId("idPotHeight1").setSelected(true);break;case"high":o.byId("idPotHeight2").setSelected(true);break;case"very high":o.byId("idPotHeight3").setSelected(true);break}switch(n.pot.shape_top){case"square":o.byId("idPotShape0").setSelected(true);break;case"round":o.byId("idPotShape1").setSelected(true);break;case"oval":o.byId("idPotShape2").setSelected(true);break;case"hexagonal":o.byId("idPotShape3").setSelected(true);break}}else{d.segments.pot=false}if(!!n.soil){d.segments.soil=true;d.soil=e.getClonedObject(n.soil)}else{d.segments.soil=false}if(a.getModel("editOrNewEvent")){a.getModel("editOrNewEvent").destroy()}var l=new i(d);a.setModel(l,"editOrNewEvent");a.open()},_getInitialEvent:function t(i){const n={diameter_width:4,material:this.oSuggestionsData["potMaterialCollection"][0].name};const o={height:0,stem_max_diameter:0,diseases:"",observation_notes:""};const s={id:undefined,soil_name:"",mix:"",description:""};const a={observation:false,pot:false,soil:false};const d={plant_id:i,date:e.getToday(),event_notes:"",pot:n,observation:o,soil:s,segments:a,mode:"new"};return d},openDialogEditSoil:function e(t,n){var o={dialog_title:"Edit Soil (ID "+n.id+")",btn_text:"Update",new:false,id:n.id,soil_name:n.soil_name,description:n.description,mix:n.mix};var s=new i(o);this.applyToFragment("dialogEditSoil",e=>{e.setModel(s,"editedSoil");e.bindElement({path:"/",model:"editedSoil"});t.addDependent(e);e.open()})},openDialogNewSoil:function e(t){var n={dialog_title:"New Soil",btn_text:"Create",new:true,id:undefined,soil_name:"",description:"",mix:""};var o=new i(n);this.applyToFragment("dialogEditSoil",e=>{e.setModel(o,"editedSoil");e.bindElement({path:"/",model:"editedSoil"});t.addDependent(e);e.open()})},_saveNewSoil:function i(n,o){var s=o.getData().SoilsCollection;var a=s.find(function(e){return e.soil_name===n.soil_name});if(a){t.show("Soil name already exists.");return}var d={id:undefined,soil_name:n.soil_name,description:n.description,mix:n.mix};e.startBusyDialog("Saving new soil...");$.ajax({url:e.getServiceUrl("events/soils"),type:"POST",contentType:"application/json",data:JSON.stringify(d),context:this}).done(this._cbSavedNewSoil.bind(this,o)).fail(this.modelsHelper.onReceiveErrorGeneric.bind(this,"Save New Soil"))},_updateExistingSoil:function t(i,n){var o={id:i.id,soil_name:i.soil_name,description:i.description,mix:i.mix};e.startBusyDialog("Saving updated soil...");$.ajax({url:e.getServiceUrl("events/soils"),type:"PUT",contentType:"application/json",data:JSON.stringify(o),context:this}).done(this._cbUpdatedExistingSoil.bind(this,n)).fail(this.modelsHelper.onReceiveErrorGeneric.bind(this,"Save New Soil"))},updateOrCreateSoil:function e(i,n){if(i.soil_name===""||i.mix===""){t.show("Enter soil mix name and mix ingredients.");return}if(i.new){if(i.id){t.show("Unexpected ID found.");return}this._saveNewSoil(i,n)}else{this._updateExistingSoil(i,n)}},_cbUpdatedExistingSoil:function i(n,o){if(!o.soil.id){t.show("Unexpected backend error - No Soil ID");return}var s=n.getData().SoilsCollection;var a=s.find(function(e){return e.id===o.soil.id});if(!a){t.show("Updated soil not found in Model");return}a.soil_name=o.soil.soil_name;a.description=o.soil.description;a.mix=o.soil.mix;n.updateBindings(false);e.stopBusyDialog();this.applyToFragment("dialogEditSoil",e=>e.close())},_cbSavedNewSoil:function i(n,o){if(!o.soil.id){t.show("Unexpected backend error - No Soil ID");return}var s=n.getData().SoilsCollection;var a={id:o.soil.id,soil_name:o.soil.soil_name,description:o.soil.description,mix:o.soil.mix};s.push(a);n.updateBindings(false);e.stopBusyDialog();this.applyToFragment("dialogEditSoil",e=>e.close())}});c.getInstance=function e(t,i){if(!c._instance&&t&&i){c._instance=new c(t,i)}return c._instance};return c});