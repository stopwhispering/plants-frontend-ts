sap.ui.define(["plants/ui/customClasses/Util","sap/m/MessageToast","sap/ui/model/json/JSONModel","sap/ui/layout/Grid","sap/ui/layout/GridData","sap/m/CustomListItem","sap/ui/base/ManagedObject","../model/ModelsHelper"],function(e,t,i,o,n,s,a,d){function l(e){return e&&e.__esModule&&typeof e.default!=="undefined"?e.default:e}const r=l(d);const c=a.extend("plants.ui.customClasses.EventsUtil",{constructor:function e(t,i){a.prototype.constructor.call(this);this.modelsHelper=r.getInstance();this.applyToFragment=t;this.oSuggestionsData=i},eventsListFactory:function e(t,i){let a=this;var d=i.getPath();var l=i.getObject();var r=new s({});r.addStyleClass("sapUiTinyMarginBottom");var c=new o({defaultSpan:"XL3 L3 M6 S12"});r.addContent(c);var p=a.byId("eventHeader").clone(t);c.addContent(p);if(!!l.observation){var v=a.byId("eventObservation").clone(t);c.addContent(v)}if(!!l.pot){var g=a.byId("eventPot").clone(t);c.addContent(g)}if(!!l.soil){var h=a.byId("eventSoil").clone(t);c.addContent(h)}var u=c.getContent().length*3-1;if(12-u<3){var f="XL12 L12"}else{f="XL"+(12-u)+" L"+(12-u)}var m=f+" M6 S12";var b=a.byId("eventImageListItem").clone(t);var _=a.byId("eventImageContainer").clone(t);_.bindAggregation("items",{path:"events>"+d+"/images",template:b,templateShareable:false});_.setLayoutData(new n({span:m}));c.addContent(_);return r},deleteEventsTableRow:function e(i,o,n){var s=o.getProperty("/PlantsEventsDict/"+n.id);var a=s.indexOf(i);if(a<0){t.show("An error happended in internal processing of deletion.");return}s.splice(a,1);o.refresh()},_getObservationData:function e(t){if(!t.segments.observation)return null;const i=JSON.parse(JSON.stringify(t.observation));if(i.observation.height===0){i.observation.height=undefined}if(i.observation.stem_max_diameter===0){i.observation.stem_max_diameter=undefined}if(!i.diseases||i.diseases.length===0){i.diseases=undefined}if(!i.event_notes||i.diseases.event_notes===0){i.event_notes=undefined}return i},_getPotData:function e(t,i){if(!t.segments.pot)return null;const o=JSON.parse(JSON.stringify(t.pot));if(i.byId("idPotHeight0").getSelected()){o.shape_side="very flat"}else if(i.byId("idPotHeight1").getSelected()){o.shape_side="flat"}else if(i.byId("idPotHeight2").getSelected()){o.shape_side="high"}else if(i.byId("idPotHeight3").getSelected()){o.shape_side="very high"}else{throw new Error("Pot height not selected")}if(i.byId("idPotShape0").getSelected()){o.shape_top="square"}else if(i.byId("idPotShape1").getSelected()){o.shape_top="round"}else if(i.byId("idPotShape2").getSelected()){o.shape_top="oval"}else if(i.byId("idPotShape3").getSelected()){o.shape_top="hexagonal"}else{throw new Error("Pot shape not selected")}return o},_getSoilData:function e(t,i){if(!t.segments.soil)return null;const o=JSON.parse(JSON.stringify(t.soil));if(!o.description||o.description.length==0){o.description=undefined}return o},_loadSoils:function t(o){var n=e.getServiceUrl("events/soils");let s=o.getModel("soils");if(!s){s=new i(n);o.setModel(s,"soils")}else{s.loadData(n)}},_addEvent:function i(o,n,s){const a=o.byId("dialogEvent");const d=a.getModel("editOrNewEvent");const l=d.getData();e.assertCorrectDate(l.date);this._assertNoDuplicateOnDate(s,l.date);const r=e.getClonedObject(l);if(r.segments.soil&&(!r.soil||!r.soil.id)){t.show("Please choose soil first.");return}const c=this._getObservationData(r);const p=this._getPotData(r,o);const v=this._getSoilData(r,o);const g={date:r.date,event_notes:r.event_notes,observation:c,pot:p,soil:v,plant_id:r.plant_id,images:[]};s.push(g);n.updateBindings(false);a.close()},_assertNoDuplicateOnDate:function e(i,o,n){const s=i.find(function(e){return e.date===o&&e!==n});if(!!s){t.show("Duplicate event on that date.");throw new Error("Duplicate event on that date.")}},_editEvent:function i(o,n,s){const a=o.byId("dialogEvent");const d=a.getModel("editOrNewEvent");const l=d.getData();if(!l.oldEvent){t.show("Can't determine old record. Aborting.");return}const r=l.oldEvent;e.assertCorrectDate(l.date);this._assertNoDuplicateOnDate(s,l.date,r);if(r.plant_id!==l.plant_id){t.show("Plant ID cannot be changed.");throw new Error("Plant ID cannot be changed.")}if(l.segments.soil&&(!l.soil||!l.soil.id)){t.show("Please choose soil first.");return}const c=this._getObservationData(l);const p=this._getPotData(l,o);const v=this._getSoilData(l,o);r.date=l.date;r.event_notes=l.event_notes;const g=c.id;r.observation=c;if(r.observation)r.observation.id=g;r.pot=p;r.soil=v;n.updateBindings(false);n.refresh(true);a.close()},addOrEditEvent:function e(t,i){var o=t.byId("dialogEvent");var n=o.getModel("editOrNewEvent");var s=n.getData();var a=s.mode;var d=t.getModel("events");var l="/PlantsEventsDict/"+i.id+"/";var r=d.getProperty(l);if(a==="edit"){this._editEvent(t,d,r)}else{this._addEvent(t,d,r)}},editEvent:function e(t,i,o){this.applyToFragment("dialogEvent",this._initEditSelectedEvent.bind(this,t,i,o))},_initEditSelectedEvent:function t(o,n,s,a){this._loadSoils(n);a.setTitle("Edit Event ("+o.date+")");n.byId("btnEventUpdateSave").setText("Update");var d=this._getInitialEvent(s);d.mode="edit";d.date=o.date;d.event_notes=o.event_notes;d.oldEvent=o;if(o.pot&&o.pot.id){d.pot.id=o.pot.id}if(o.observation&&o.observation.id){d.observation.id=o.observation.id}if(!!o.observation){d.segments.observation=true;d.observation.diseases=o.observation.diseases;d.observation.height=o.observation.height;d.observation.observation_notes=o.observation.observation_notes;d.observation.stem_max_diameter=o.observation.stem_max_diameter}else{d.segments.observation=false}if(!!o.pot){d.segments.pot=true;d.pot.diameter_width=o.pot.diameter_width;d.pot.material=o.pot.material;switch(o.pot.shape_side){case"very flat":n.byId("idPotHeight0").setSelected(true);break;case"flat":n.byId("idPotHeight1").setSelected(true);break;case"high":n.byId("idPotHeight2").setSelected(true);break;case"very high":n.byId("idPotHeight3").setSelected(true);break}switch(o.pot.shape_top){case"square":n.byId("idPotShape0").setSelected(true);break;case"round":n.byId("idPotShape1").setSelected(true);break;case"oval":n.byId("idPotShape2").setSelected(true);break;case"hexagonal":n.byId("idPotShape3").setSelected(true);break}}else{d.segments.pot=false}if(!!o.soil){d.segments.soil=true;d.soil=e.getClonedObject(o.soil)}else{d.segments.soil=false}if(a.getModel("editOrNewEvent")){a.getModel("editOrNewEvent").destroy()}var l=new i(d);a.setModel(l,"editOrNewEvent");a.open()},_getInitialEvent:function t(i){const o={diameter_width:4,material:this.oSuggestionsData["potMaterialCollection"][0].name};const n={height:0,stem_max_diameter:0,diseases:"",observation_notes:""};const s={id:undefined,soil_name:"",mix:"",description:""};const a={observation:false,pot:false,soil:false};const d={plant_id:i,date:e.getToday(),event_notes:"",pot:o,observation:n,soil:s,segments:a,mode:"new"};return d},openDialogEditSoil:function e(t,o){var n={dialog_title:"Edit Soil (ID "+o.id+")",btn_text:"Update",new:false,id:o.id,soil_name:o.soil_name,description:o.description,mix:o.mix};var s=new i(n);this.applyToFragment("dialogEditSoil",e=>{e.setModel(s,"editedSoil");e.bindElement({path:"/",model:"editedSoil"});t.addDependent(e);e.open()})},openDialogNewSoil:function e(t){var o={dialog_title:"New Soil",btn_text:"Create",new:true,id:undefined,soil_name:"",description:"",mix:""};var n=new i(o);this.applyToFragment("dialogEditSoil",e=>{e.setModel(n,"editedSoil");e.bindElement({path:"/",model:"editedSoil"});t.addDependent(e);e.open()})},_saveNewSoil:function i(o,n){var s=n.getData().SoilsCollection;var a=s.find(function(e){return e.soil_name===o.soil_name});if(a){t.show("Soil name already exists.");return}var d={id:undefined,soil_name:o.soil_name,description:o.description,mix:o.mix};e.startBusyDialog("Saving new soil...");$.ajax({url:e.getServiceUrl("events/soils"),type:"POST",contentType:"application/json",data:JSON.stringify(d),context:this}).done(this._cbSavedNewSoil.bind(this,n)).fail(this.modelsHelper.onReceiveErrorGeneric.bind(this,"Save New Soil"))},_updateExistingSoil:function t(i,o){var n={id:i.id,soil_name:i.soil_name,description:i.description,mix:i.mix};e.startBusyDialog("Saving updated soil...");$.ajax({url:e.getServiceUrl("events/soils"),type:"PUT",contentType:"application/json",data:JSON.stringify(n),context:this}).done(this._cbUpdatedExistingSoil.bind(this,o)).fail(this.modelsHelper.onReceiveErrorGeneric.bind(this,"Save New Soil"))},updateOrCreateSoil:function e(i,o){if(i.soil_name===""||i.mix===""){t.show("Enter soil mix name and mix ingredients.");return}if(i.new){if(i.id){t.show("Unexpected ID found.");return}this._saveNewSoil(i,o)}else{this._updateExistingSoil(i,o)}},_cbUpdatedExistingSoil:function i(o,n){if(!n.soil.id){t.show("Unexpected backend error - No Soil ID");return}var s=o.getData().SoilsCollection;var a=s.find(function(e){return e.id===n.soil.id});if(!a){t.show("Updated soil not found in Model");return}a.soil_name=n.soil.soil_name;a.description=n.soil.description;a.mix=n.soil.mix;o.updateBindings(false);e.stopBusyDialog();this.applyToFragment("dialogEditSoil",e=>e.close())},_cbSavedNewSoil:function i(o,n){if(!n.soil.id){t.show("Unexpected backend error - No Soil ID");return}var s=o.getData().SoilsCollection;var a={id:n.soil.id,soil_name:n.soil.soil_name,description:n.soil.description,mix:n.soil.mix};s.push(a);o.updateBindings(false);e.stopBusyDialog();this.applyToFragment("dialogEditSoil",e=>e.close())}});c.getInstance=function e(t,i){if(!c._instance&&t&&i){c._instance=new c(t,i)}return c._instance};return c});